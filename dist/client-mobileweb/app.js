var http=http||{};
http.Factory=http.Factory||function(){return{create:function(a){var a=a||{},c=a.timeout||6E4,b=a.onload||function(){},f=a.onerror||function(){},d=a.onprogress||function(){},a=a.ontimeout||function(){};if("undefined"!==typeof XDomainRequest){var e=new XDomainRequest;e.timeout=c;e.onload=function(){e.fix=!0;b()};e.onerror=f;e.onprogress=d;e.ontimeout=a;e.setRequestHeader=function(){};e.setUserAgent=function(){};return e}if("undefined"!==typeof XMLHttpRequest){var g=new XMLHttpRequest;g.timeout=c;g.onload=
b;g.onerror=f;g.onprogress=d;g.ontimeout=a;g.setUserAgent=function(){};return g}if("undefined"!==typeof Ti){var h=Ti.Network.createHTTPClient({timeout:c,onload:b,onerror:f,onprogress:d,ontimeout:a});h.setUserAgent=function(b){h.setRequestHeader("User-Agent",b)};return h}throw Error("Could not find an HttpClient implementation.");}}}();http.create=http.create||http.Factory.create;var lineapp=lineapp||{};
lineapp.Client=lineapp.Client||function(a){return function(a){var a=a||{},b=a.apiUrl||"https://lineapp-prod.appspot.com/v1.0",a={},f=new lineapp.Protocol;a.request=function(a){a=a||{};f.post({url:b,obj:a.request||null,callback:a.callback||function(){}})};return a}(a)};lineapp=lineapp||{};
lineapp.EventHub=lineapp.EventHub||function(){return function(){var a={},c={};a.addEventListener=function(b,a){var d=c[b];"undefined"===typeof d&&(d=[],c[b]=d);d.push(a)};a.removeEventListener=function(b,a){var d=c[b];if("undefined"!==typeof d){var e=d.indexOf(a);-1!==e&&d.splice(e,1);0==d.length&&delete c[b]}};a.removeAllListeners=function(){c={}};a.addGeneralEventListener=function(b){a.addEventListener("__all__",b)};a.removeGeneralEventListener=function(b){a.removeEventListener("__all__",b)};a.fireEvent=
function(b,a){var d=c[b];if("undefined"!==typeof d)for(var e=0,g=d.length;e<g;++e)d[e](a);d=c.__all__;if("undefined"!==typeof d){e=0;for(g=d.length;e<g;++e)d[e](b,a)}};a.getNumListeners=function(){var b=0,a;for(a in c)b+=c[a].length;return b};return a}()};lineapp=lineapp||{};
lineapp.LineAppService=lineapp.LineAppService||function(){var a=new lineapp.EventHub,c=null;a.request=function(a){var a=a||{},f=a.request||{},d=a.promise||new utils.Promise;if(a.callback){var e=a.callback;d.done(function(){e.apply(this,arguments)})}c.request({request:f,callback:function(a){d.resolve(a)}})};a.init=function(a){a=a||{};c=a.client||null};return a}();lineapp=lineapp||{};
lineapp.LineManagement=lineapp.LineManagement||function(a){return function(){function a(b){switch(b.type){case "join":d.NORMAL.push({id:b.clientId,ask:f});break;default:console.warn("Unkown event type",b)}}var b=new lineapp.EventHub,f=500,d={};b.init=function(b){b=b.events;"create"!==b.shift().type?alert("First event is not create!"):(d={NORMAL:[],VIP:[]},_.each(b,a))};b.handleEvents=function(d){_.each(d,a);b.fireEvent("changed",{events:d})};b.getLines=function(){return d};return b}(a)};
lineapp=lineapp||{};lineapp.getDefaultUserAgent=function(){return"lineapp4js (gzip)"};
lineapp.Protocol=lineapp.Protocol||function(a){return function(a){var a=a||{},b=a.userAgent||lineapp.getDefaultUserAgent();return{post:function(a){var c=a.url||null,e=a.obj||null,g=a.callback||function(){},h=http.create({onload:function(){g(JSON.parse(h.responseText))},onerror:function(){g({error:{code:"protocol",message:"protocol error"}})},timeout:a.timeout||6E4});h.open("POST",c);h.setUserAgent(b);h.setRequestHeader("Content-Type","application/json");h.setRequestHeader("Accept","application/json");
h.send(JSON.stringify(e))}}}(a)};var utils=utils||{};utils.Promise=utils.Promise||function(){function a(){if(c)for(;0<b.length;)b.pop().apply(this,f)}var c=!1,b=[],f;this.done=function(c){b.push(c);a();return this};this.resolve=function(){f=_.toArray(arguments);c=!0;a()};this.isResolved=function(){return c};this.getValue=function(){return f};return this};
utils.Promise.when=function(){function a(){c||_.all(_.invoke(b,"isResolved"))&&f.resolve.apply(this,_.map(b,function(a){return a.getValue()[0]}))}var c=!1,b=[],f=new utils.Promise;_.each(arguments,function(c){var e=(new utils.Promise).done(a);b.push(e);c=c(e);c instanceof utils.Promise&&c.done(function(a){e.resolve(a)})});return f};lineapp=lineapp||{};
lineapp.Facebook="undefined"!==typeof FB?lineapp.Facebook||function(){function a(){d=f=null;b.fireEvent("logout")}function c(a){b.login(a.userID,a.accessToken)}var b=new lineapp.EventHub,f=null,d=null,e=!1,g=null;b.init=function(b){var b=b||{},d=b.channelUrl||null;g=b.appId||null;e=b.dontUseFB||!1;e||(FB.init({appId:g,channelUrl:d,status:!0,cookie:!0,xfbml:!0,oauth:!0}),FB.getLoginStatus(function(b){b.authResponse?c(b.authResponse):a()}))};b.getLoggedIn=function(){return null!==f};b.getAccessToken=
function(){return f};b.authorize=function(){e||FB.login(function(b){b.authResponse?c(b.authResponse):a()},void 0)};b.getUid=function(){return d};b.logout=function(){e?a():FB.logout()};b.getGraphPath=function(a,c,d){var e=http.create({onload:function(){d({success:!0,result:e.responseText})},onerror:function(a){d({error:!0,event:a})}}),a="https://graph.facebook.com/"+a,c=new lineapp.QueryStringBuilder(c);c.append("access_token",b.getAccessToken());a+=c.toString();e.autoEncodeUrl=!1;e.open("GET",a);
e.send()};b.login=function(a,c){f=c;d=a;b.fireEvent("login",{success:!0});lineapp.LineAppService.request({request:{type:"extend",accessToken:f,fbAppId:g},callback:function(a){a.error||(f=a.value.accessToken)}})};FB.Event.subscribe("auth.login",function(a){c(a.authResponse)});FB.Event.subscribe("auth.logout",function(){a()});return b}():lineapp.Facebook||function(){var a=new lineapp.EventHub;a.init=function(){};a.getLoggedIn=function(){return!1};a.getAccessToken=function(){return null};a.authorize=
function(){};a.getUid=function(){return null};a.logout=function(){};a.getGraphPath=function(a,b,f){f({error:!0})};return a}();lineapp=lineapp||{};lineapp.GetInLinePresenter=lineapp.GetInLinePresenter||function(a){return function(){var a=new lineapp.EventHub,b=new lineapp.GetInLineView;b.addEventListener("lineup",function(b){a.fireEvent("lineup",b)});a.getView=function(){return b};return a}(a)};lineapp=lineapp||{};
lineapp.InLinePresenter=lineapp.InLinePresenter||function(a){return function(){var a=new lineapp.EventHub,b=new lineapp.InLineView;a.getView=function(){return b};return a}(a)};lineapp=lineapp||{};
lineapp.LineAppPresenter=lineapp.LineAppPresenter||function(a){return function(){function a(){if(h)console.warn("onLogin >> called twice.");else{h=!0;console.log("onLogin >> Start.");var c=[{type:"create",vipPrice:1E4,israeliMode:!1}];console.log("onEvents >> Start.",c);g.init({events:c});c=_.values(g.getLines());c=_.chain(c).flatten().pluck("id").contains(lineapp.Facebook.getUid()).value();console.log("onEvents >> inLine",c);c?f():b()}}function b(){var a=new lineapp.GetInLinePresenter;e.showGetInLineView(a.getView());
a.addEventListener("lineup",function(){_.defer(function(){g.handleEvents([{type:"join",clientId:lineapp.Facebook.getUid()}]);f()})})}function f(){var a=new lineapp.InLinePresenter;e.showInLineView(a.getView())}var d=new lineapp.EventHub,e=new lineapp.LineAppView,g=new lineapp.LineManagement;d.open=function(){console.log("open >> Start.");lineapp.Facebook.getLoggedIn()?(console.log("open >> Already logged in."),a()):(console.log("open >> Logging in."),lineapp.Facebook.addEventListener("login",function(b){console.log("open >> Logged in.",
b);a()}),lineapp.Facebook.authorize())};var h=!1;d.getView=function(){return e};return d}(a)};lineapp=lineapp||{};lineapp.GetInLineView=lineapp.GetInLineView||function(a){return function(){var a=new lineapp.EventHub,b=$("<div></div>");$("<button></button>").html("Get In Line!").appendTo(b).on("click",function(){a.fireEvent("lineup")});a.getDom=function(){return b};return a}(a)};lineapp=lineapp||{};
lineapp.InLineView=lineapp.InLineView||function(a){return function(){var a=new lineapp.EventHub,b=$("<div></div>");$("<div>In Line!</div>").appendTo(b);a.getDom=function(){return b};return a}(a)};lineapp=lineapp||{};
lineapp.LineAppView=lineapp.LineAppView||function(a){return function(){var a=new lineapp.EventHub,b=$("<div></div>",{"class":"lineapp_lineappview_wrapper"});a.showWaiting=function(){};a.hideWaiting=function(){};a.showLogin=function(a){b.empty();b.append(a.getDom())};a.showGetInLineView=function(a){b.empty();b.append(a.getDom())};a.showInLineView=function(a){b.empty();b.append(a.getDom())};a.getDom=function(){return b};return a}(a)};if("undefined"===typeof console)var console={log:function(){},warn:function(){}};
var localurl=window.location.protocol+"//"+window.location.host,client=new lineapp.Client;function init(){lineapp.LineAppService.init({client:client});lineapp.Facebook.init({appId:"471521269618702",channelUrl:localurl+"/static/channel.html"});var a=lineapp.LineAppPresenter();$(body).append(a.getView().getDom());a.open()}init();
