var http=http||{};
http.Factory=http.Factory||function(){return{create:function(c){var c=c||{},b=c.timeout||6E4,a=c.onload||function(){},g=c.onerror||function(){},d=c.onprogress||function(){},c=c.ontimeout||function(){};if("undefined"!==typeof XDomainRequest){var f=new XDomainRequest;f.timeout=b;f.onload=function(){f.fix=!0;a()};f.onerror=g;f.onprogress=d;f.ontimeout=c;f.setRequestHeader=function(){};f.setUserAgent=function(){};return f}if("undefined"!==typeof XMLHttpRequest){var e=new XMLHttpRequest;e.timeout=b;e.onload=
a;e.onerror=g;e.onprogress=d;e.ontimeout=c;e.setUserAgent=function(){};return e}if("undefined"!==typeof Ti){var h=Ti.Network.createHTTPClient({timeout:b,onload:a,onerror:g,onprogress:d,ontimeout:c});h.setUserAgent=function(a){h.setRequestHeader("User-Agent",a)};return h}throw Error("Could not find an HttpClient implementation.");}}}();http.create=http.create||http.Factory.create;var lineapp=lineapp||{};
lineapp.Client=lineapp.Client||function(c){return function(b){var b=b||{},a=b.apiUrl||"https://lineapp-prod.appspot.com/v1.0",b={},g=new lineapp.Protocol;b.request=function(b){b=b||{};g.post({url:a,obj:b.request||null,callback:b.callback||function(){}})};return b}(c)};lineapp=lineapp||{};
lineapp.EventHub=lineapp.EventHub||function(){return function(){var c={},b={};c.addEventListener=function(a,g){var d=b[a];"undefined"===typeof d&&(d=[],b[a]=d);d.push(g)};c.removeEventListener=function(a,g){var d=b[a];if("undefined"!==typeof d){var c=d.indexOf(g);-1!==c&&d.splice(c,1);0==d.length&&delete b[a]}};c.removeAllListeners=function(){b={}};c.addGeneralEventListener=function(a){c.addEventListener("__all__",a)};c.removeGeneralEventListener=function(a){c.removeEventListener("__all__",a)};c.fireEvent=
function(a,g){var d=b[a];if("undefined"!==typeof d)for(var c=0,e=d.length;c<e;++c)d[c](g);d=b.__all__;if("undefined"!==typeof d){c=0;for(e=d.length;c<e;++c)d[c](a,g)}};c.getNumListeners=function(){var a=0,c;for(c in b)a+=b[c].length;return a};return c}()};lineapp=lineapp||{};
lineapp.LineAppService=lineapp.LineAppService||function(){var c=new lineapp.EventHub,b=null;c.request=function(a){var a=a||{},c=a.request||{},d=a.promise||new utils.Promise;if(a.callback){var f=a.callback;d.done(function(){f.apply(this,arguments)})}b.request({request:c,callback:function(a){d.resolve(a)}})};c.init=function(a){a=a||{};b=a.client||null};return c}();lineapp=lineapp||{};
lineapp.LineManagement=lineapp.LineManagement||function(c){return function(){function b(b){l=b.timestamp;switch(b.type){case "join":i.NORMAL.push({id:b.clientId.id,clientId:b.clientId,ask:null,joinTimestamp:b.timestamp});break;case "leave":a(b);break;case "set_price":c(b);break;case "swap":d(b);break;default:console.warn("Unkown event type",b)}}function a(a){i.NORMAL=_.reject(i.NORMAL,function(b){return b.id===a.clientId.id});i.VIP=_.reject(i.VIP,function(b){return b.id===a.clientId.id})}function c(a){_.each(i.NORMAL,
function(b){b.id===a.clientId.id&&(b.ask=a.price)});_.each(i.VIP,function(b){b.id===a.clientId.id&&(b.ask=a.price)})}function d(a){var b=a.clientId;_.each(a.clientIds,function(a){var c,d,h,g;_.each(i,function(e,f){_.each(e,function(e,i){_.isEqual(e.clientId,b)&&(h=f,g=i);_.isEqual(e.clientId,a)&&(c=f,d=i)})});var e=i[c][d];i[c][d]=i[h][g];i[h][g]=e})}function f(){m&&e({},function(){setTimeout(f,5E3)})}function e(a,b){j.push({request:a,callback:b});n||h()}function h(){if(0===j.length)n=!1;else{n=!0;
var a=j.shift(),c={type:"update",lineId:o,after:l,accessToken:lineapp.Facebook.getAccessToken()},c=_.extend(c,a.request);lineapp.LineAppService.request({request:c,callback:function(c){try{if(c.error)alert(c.error.message);else{var d=c.value.events||[];_.each(d,b);k.fireEvent("changed",{events:d})}}catch(g){}a.callback&&a.callback();h()}})}}var k=new lineapp.EventHub,i={},o=null,l=null;k.init=function(a){var c=a.events;o=a.lineId;"create"!==c.shift().type?alert("First event is not create!"):(i={NORMAL:[],
VIP:[]},_.each(c,b))};k.performEvents=function(a){e({events:a})};k.getLines=function(){return i};var m=!1;k.startMonitoring=function(){m||(m=!0,f())};k.stopMonitoring=function(){m=!1};var j=[],n=!1;return k}(c)};lineapp=lineapp||{};lineapp.getDefaultUserAgent=function(){return"lineapp4js (gzip)"};
lineapp.Protocol=lineapp.Protocol||function(c){return function(b){var b=b||{},a=b.userAgent||lineapp.getDefaultUserAgent();return{post:function(b){var c=b.url||null,f=b.obj||null,e=b.callback||function(){},h=http.create({onload:function(){e(JSON.parse(h.responseText))},onerror:function(){e({error:{code:"protocol",message:"protocol error"}})},timeout:b.timeout||6E4});h.open("POST",c);h.setUserAgent(a);h.setRequestHeader("Content-Type","application/json");h.setRequestHeader("Accept","application/json");
h.send(JSON.stringify(f))}}}(c)};var utils=utils||{};utils.Promise=utils.Promise||function(){function c(){if(b)for(;0<a.length;)a.pop().apply(this,g)}var b=!1,a=[],g;this.done=function(b){a.push(b);c();return this};this.resolve=function(){g=_.toArray(arguments);b=!0;c()};this.isResolved=function(){return b};this.getValue=function(){return g};return this};
utils.Promise.when=function(){function c(){b||_.all(_.invoke(a,"isResolved"))&&g.resolve.apply(this,_.map(a,function(a){return a.getValue()[0]}))}var b=!1,a=[],g=new utils.Promise;_.each(arguments,function(b){var g=(new utils.Promise).done(c);a.push(g);b=b(g);b instanceof utils.Promise&&b.done(function(a){g.resolve(a)})});return g};lineapp=lineapp||{};
lineapp.Facebook="undefined"!==typeof FB?lineapp.Facebook||function(){function c(){d=g=null;a.fireEvent("logout")}function b(b){a.login(b.userID,b.accessToken)}var a=new lineapp.EventHub,g=null,d=null,f=!1,e=null;a.init=function(a){var a=a||{},g=a.channelUrl||null;e=a.appId||null;f=a.dontUseFB||!1;f||(FB.init({appId:e,channelUrl:g,status:!0,cookie:!0,xfbml:!0,oauth:!0}),FB.getLoginStatus(function(a){a.authResponse?b(a.authResponse):c()}))};a.getLoggedIn=function(){return null!==g};a.getAccessToken=
function(){return g};a.authorize=function(){f||FB.login(function(a){a.authResponse?b(a.authResponse):c()},void 0)};a.getUid=function(){return d};a.logout=function(){f?c():FB.logout()};a.getGraphPath=function(b,c,g){var d=http.create({onload:function(){g({success:!0,result:d.responseText})},onerror:function(a){g({error:!0,event:a})}}),b="https://graph.facebook.com/"+b,c=new lineapp.QueryStringBuilder(c);c.append("access_token",a.getAccessToken());b+=c.toString();d.autoEncodeUrl=!1;d.open("GET",b);
d.send()};a.login=function(b,c){g=c;d=b;a.fireEvent("login",{success:!0});lineapp.LineAppService.request({request:{type:"extend",accessToken:g,fbAppId:e},callback:function(a){a.error||(g=a.value.accessToken)}})};FB.Event.subscribe("auth.login",function(a){b(a.authResponse)});FB.Event.subscribe("auth.logout",function(){c()});return a}():lineapp.Facebook||function(){var c=new lineapp.EventHub;c.init=function(){};c.getLoggedIn=function(){return!1};c.getAccessToken=function(){return null};c.authorize=
function(){};c.getUid=function(){return null};c.logout=function(){};c.getGraphPath=function(b,a,c){c({error:!0})};return c}();lineapp=lineapp||{};lineapp.GetInLinePresenter=lineapp.GetInLinePresenter||function(c){return function(){var b=new lineapp.EventHub,a=new lineapp.GetInLineView;a.addEventListener("lineup",function(a){b.fireEvent("lineup",a)});b.getView=function(){return a};return b}(c)};lineapp=lineapp||{};
lineapp.InLineApprovePayPresenter=lineapp.InLineApprovePayPresenter||function(c){return function(b){var a=b.payKey,b=b.requests,c=new lineapp.EventHub,d=new lineapp.InLineApprovePayView({payKey:a,requests:b});d.addEventListener("close",function(){c.fireEvent("close")});c.getView=function(){return d};return c}(c)};lineapp=lineapp||{};
lineapp.InLinePresenter=lineapp.InLinePresenter||function(c){return function(b){var a=new lineapp.EventHub,c=b.lineManagement,d=new lineapp.InLineConfigPresenter({lineManagement:c}),f=new lineapp.InLineLinePresenter({lineManagement:c}),e=new lineapp.InLineView;e.addConfigView(d.getView());e.addLineView(f.getView());d.addEventListener("leave",function(){a.fireEvent("leave")});f.addEventListener("swap",function(a){var b,d,f,l,m=a.partner,a=c.getLines(),j={};_.each(a,function(a,c){j[c]=[];_.each(a,function(a,
g){j[c].push(a);a.id===lineapp.Facebook.getUid()&&(f=c,l=g);a.id===m&&(b=c,d=g)})});if(f===b&&!(l<d)){j=j[f];j=_.first(j,l);0<d&&(j=_.rest(j,d));j.reverse();var n=_.pluck(j,"ask"),j=_.pluck(j,"clientId");e.showApprovePay();lineapp.LineAppService.request({request:{type:"create_payment",paymentRequests:n},callback:function(a){a.error?alert(a.error.message):(a=lineapp.InLineApprovePayPresenter({payKey:a.value.payKey,requests:n}),e.fillApprovePay(a.getView()),a.addEventListener("close",function(){e.closeApprovePay()}))}})}});
a.close=function(){d.close();f.close()};a.getView=function(){return e};return a}(c)};lineapp=lineapp||{};
lineapp.InLineConfigPresenter=lineapp.InLineConfigPresenter||function(c){return function(b){var a=new lineapp.EventHub,c=b.lineManagement,d=new lineapp.InLineConfigView;a.update=function(){var a=c.getLines();_.each(a,function(a){_.each(a,function(a,b){a.id===lineapp.Facebook.getUid()&&(d.setPosition(b+1),d.setTimeInLine(a.joinTimestamp),d.setAsk(a.ask),d.setEta(1E3),d.setTotalEarned(0))})})};a.update();d.addEventListener("leave",function(){a.fireEvent("leave")});d.addEventListener("setprice",function(a){c.performEvents([{type:"set_price",
price:{destination:"yoavamit@yahoo.com",currency:"USD",amount:a.value},clientId:{ns:"com.facebook",id:lineapp.Facebook.getUid()}}])});a.close=function(){d.close()};a.getView=function(){return d};return a}(c)};
lineapp.InLineLinePresenter=lineapp.InLineLinePresenter||function(c){return function(b){var a=new lineapp.EventHub,c=b.lineManagement,d=new lineapp.InLineLineView;d.initLines(c.getLines());var f=function(a){_.each(a.events,function(a){console.log("Handling",a.type);switch(a.type){case "join":d.onJoinEvent({person:{id:a.clientId.id,clientId:a.clientId,ask:null,joinTimestamp:a.timestamp}});break;case "leave":d.onLeaveEvent({person:{id:a.clientId.id,clientId:a.clientId}});break;case "set_price":d.onSetPriceEvent({person:{id:a.clientId.id,
clientId:a.clientId},amount:a.price.amount});break;case "swap":d.onSwapEvent({clientId:a.clientId,clientIds:a.clientIds})}})};c.addEventListener("changed",f);d.addEventListener("swap",function(b){a.fireEvent("swap",b)});a.getView=function(){return d};a.close=function(){c.removeEventListener("changed",f)};return a}(c)};lineapp=lineapp||{};
lineapp.LineAppPresenter=lineapp.LineAppPresenter||function(c){return function(){function b(){i?console.warn("onLogin >> called twice."):(i=!0,console.log("onLogin >> Start."),lineapp.LineAppService.request({request:{type:"update",lineId:k},callback:function(b){b.error&&alert(b.error.message);b=b.value.events||[];console.log("onEvents >> Start.",b);h.init({events:b,lineId:k});h.startMonitoring();b=a();console.log("onEvents >> inLine",b);b?d():c()}}))}function a(){var a=_.values(h.getLines());return _.chain(a).flatten().pluck("id").contains(lineapp.Facebook.getUid()).value()}
function c(){var b=new lineapp.GetInLinePresenter;e.showGetInLineView(b.getView());b.addEventListener("lineup",function(){e.showWaiting();h.performEvents([{type:"join",clientId:{ns:"com.facebook",id:lineapp.Facebook.getUid()}}])});var g=function(){console.log("onNotInLine >> Checking if inline");a()&&(h.removeEventListener("changed",g),d())};h.addEventListener("changed",g);e.hideWaiting()}function d(){console.log("onInLine >> Start");var b=new lineapp.InLinePresenter({lineManagement:h});e.showInLineView(b.getView());
b.addEventListener("leave",function(){e.showWaiting();h.performEvents([{type:"leave",clientId:{ns:"com.facebook",id:lineapp.Facebook.getUid()}}])});var d=function(){console.log("onNotInLine >> Checking if not inline");a()||(h.removeEventListener("changed",d),b.close(),c())};h.addEventListener("changed",d);e.hideWaiting()}var f=new lineapp.EventHub,e=new lineapp.LineAppView,h=new lineapp.LineManagement,k="5741031244955648";f.open=function(){console.log("open >> Start.");if(lineapp.Facebook.getLoggedIn())console.log("open >> Already logged in."),
b();else{console.log("open >> Logging in.");lineapp.Facebook.addEventListener("login",function(a){console.log("open >> Logged in.",a);b()});var a=new lineapp.LoginPresenter;e.showLogin(a.getView())}};var i=!1;f.getView=function(){return e};return f}(c)};lineapp=lineapp||{};
lineapp.LoginPresenter=lineapp.LoginPresenter||function(c){return function(){var b=new lineapp.EventHub,a=new lineapp.LoginView;a.addEventListener("login",function(){lineapp.Facebook.authorize()});b.getView=function(){return a};return b}(c)};lineapp=lineapp||{};
lineapp.GetInLineView=lineapp.GetInLineView||function(c){return function(){var b=new lineapp.EventHub,a=$("<div></div>",{"class":"lineapp_getinlineview_wrapper"});$("<button></button>").html("Get In Line!").appendTo(a).on("click",function(){b.fireEvent("lineup")});b.getDom=function(){return a};return b}(c)};lineapp=lineapp||{};
lineapp.InLineApprovePayView=lineapp.InLineApprovePayView||function(c){return function(b){var a=b.payKey,b=b.requests,c=new lineapp.EventHub,d=$("<div></div>",{"class":"lineapp_inlineapprovepayview_wrapper"}),f=_.uniqueId();$("<div class='header'></div>").appendTo(d);$("<div class='info'></div>").html("You are about to cut "+b.length+" people in line for a miniscule sum of:").appendTo(d);$("<div class='amount'></div>").html("$"+_.reduce(b,function(a,b){return a+b.amount},0)/100).appendTo(d);$("<div class='close'></div>").appendTo(d).on("click",
function(){c.fireEvent("close")});d.append($('<form id="form" action="https://www.sandbox.paypal.com/webapps/adaptivepayment/flow/pay" target="PPDGFrame" class="standard"><input type="submit" id="'+f+'" class="submitbutton"><input id="type" type="hidden" name="expType" value="mini"><input id="paykey" type="hidden" name="paykey" value="'+a+'"></form>'));new PAYPAL.apps.DGFlow({trigger:f});c.getDom=function(){return d};return c}(c)};lineapp=lineapp||{};
lineapp.InLineConfigView=lineapp.InLineConfigView||function(c){return function(){function b(){if(d){var b=(new Date).getTime()-d,b=parseInt(b/1E3),c=parseInt(b/60/60),e=parseInt(b/60)-60*c,b=b-60*e-3600*c;h.html(a(c)+":"+a(e)+":"+a(b))}}function a(a){a=""+a;1===a.length&&(a="0"+a);return a}var c=new lineapp.EventHub,d=null,f=$("<div></div>",{"class":"lineapp_inlineconfigview_wrapper"}),e=$("<div></div>",{"class":"position"}).appendTo(f),h=$("<div></div>",{"class":"timeinline"}).appendTo(f),k=$("<div></div>",
{"class":"timeeta"}).appendTo(f),i=$("<select></select>").appendTo(f),o=$("<div></div>").appendTo(f);$("<button></button>").html("Leave").appendTo(f).on("click",function(){c.fireEvent("leave")});$("<option></option>",{value:100,html:"$1"}).appendTo(i);$("<option></option>",{value:200,html:"$2"}).appendTo(i);$("<option></option>",{value:300,html:"$3"}).appendTo(i);$("<option></option>",{value:400,html:"$4"}).appendTo(i);$("<option></option>",{value:500,html:"$5"}).appendTo(i);$("<option></option>",
{value:600,html:"$6"}).appendTo(i);$("<option></option>",{value:700,html:"$7"}).appendTo(i);$("<option></option>",{value:800,html:"$8"}).appendTo(i);$("<option></option>",{value:900,html:"$9"}).appendTo(i);i.change(function(){c.fireEvent("setprice",{value:i.val()})});var l=setInterval(b,1E3);c.setPosition=function(a){e.html(a)};c.setTimeInLine=function(a){d=a;b()};c.setEta=function(a){k.html(a)};c.setAsk=function(a){i.val(a)};c.setTotalEarned=function(a){o.val(a)};c.getDom=function(){return f};c.close=
function(){clearInterval(l);intervalId=null};return c}(c)};lineapp=lineapp||{};
lineapp.InLineLineView=lineapp.InLineLineView||function(c){return function(){function b(a,b){j+=m;i.css({width:j});var d=$("<div></div>",{"class":"spotsaver"}).appendTo(b);_.defer(function(){var f=$("<div></div>",{"class":"person"}).css({left:d.position().left+5}).hide().appendTo(b).fadeIn({complete:c});$("<img />",{"class":"face"}).appendTo(f).attr("src","http://graph.facebook.com/"+a.id+"/picture?type=square");var i=$("<div></div>",{"class":"info"}).html((a.ask||{}).amount||"N/A").appendTo(f);f.addClass("creature"+
(a.id%3+1));h[a.id]={dom:f,spot:d,ask:i};if(a.id!==lineapp.Facebook.getUid())f.on("click",function(){e.fireEvent("swap",{partner:a.id})})})}function a(a){n.push(a);p||c()}function c(){if(0===n.length)p=!1;else{p=!0;var a=n.shift();console.log("Animating",a.type);switch(a.type){case "join":a=a.params.person;console.log(a);b(a,l);break;case "leave":d(a.params);break;case "swap":f(a.params)}}}function d(a){function b(){f--;0>=f&&(h[d.id].dom.remove(),h[d.id].spot.remove(),delete h[d.id],j-=m,i.css({width:j}),
c())}var d=a.person,e=parseInt(h[d.id].dom.css("left"));console.log(e);var f=0;_.each(h,function(a){var c=parseInt(a.dom.css("left"));c>e&&(f++,a.dom.animate({left:c-m},b))});f++;h[d.id].dom.fadeOut({complete:b});f++;h[d.id].spot.fadeOut({complete:b})}function f(a){var b=h[a.clientId1.id].dom,a=h[a.clientId2.id].dom,d=0;b.animate({left:a.css("left"),duration:1E3},function(){d++;2===d&&c()});a.animate({left:b.css("left"),duration:1E3},function(){d++;2===d&&c()})}var e=new lineapp.EventHub,h={},k=$("<div></div>",
{"class":"lineapp_inlinelineview_wrapper"}),i=$("<div></div>",{"class":"waitingline"}).appendTo(k);$("<div></div>",{"class":"desk"}).appendTo(i);var o=$("<div></div>",{"class":"vipline"}).appendTo(i),l=$("<div></div>",{"class":"normalline"}).appendTo(i),m=78,j=m;e.initLines=function(a){o.empty();l.empty();h={};_.each(a.VIP,function(a){b(a,o)});_.each(a.NORMAL,function(a){b(a,l)})};e.onJoinEvent=function(b){a({type:"join",params:b})};e.onLeaveEvent=function(b){a({type:"leave",params:b})};e.onSetPriceEvent=
function(a){h[a.person.id].ask.html(a.amount)};e.onSwapEvent=function(b){var c=b.clientId;_.each(b.clientIds,function(b){a({type:"swap",params:{clientId1:c,clientId2:b}})})};var n=[],p=!1;e.getDom=function(){return k};return e}(c)};lineapp=lineapp||{};
lineapp.InLineView=lineapp.InLineView||function(c){return function(){var b=new lineapp.EventHub,a=$("<div></div>",{"class":"lineapp_inlineview_wrapper"}),c=$("<div></div>",{"class":"config"}).appendTo(a),d=$("<div></div>",{"class":"line"}).appendTo(a),f=$("<div></div>",{"class":"approvepaymentmask"}).appendTo(a),e=$("<div></div>",{"class":"approvepayment"}).appendTo(a);e.append($("<i class='icon-spin icon-spinner'></i>"));b.showApprovePay=function(){f.show();e.show()};b.fillApprovePay=function(a){e.empty();
e.append(a.getDom())};b.closeApprovePay=function(){e.hide();f.hide();e.empty();e.append($("<i class='icon-spin icon-spinner'></i>"))};b.approvePayment=function(){};b.addConfigView=function(a){c.append(a.getDom())};b.addLineView=function(a){d.append(a.getDom())};b.getDom=function(){return a};return b}(c)};lineapp=lineapp||{};
lineapp.LineAppView=lineapp.LineAppView||function(c){return function(){var b=new lineapp.EventHub,a=$("<div></div>",{"class":"lineapp_lineappview_wrapper"}),c=$("<div></div>",{"class":"waiting"}).appendTo(a);$("<i class='icon-spin icon-spinner'></i>").appendTo(c);c.hide();b.showWaiting=function(){c.show()};b.hideWaiting=function(){c.hide()};b.showLogin=function(b){a.empty();a.append(c);a.append(b.getDom())};b.showGetInLineView=function(b){a.empty();a.append(c);a.append(b.getDom())};b.showInLineView=
function(b){a.empty();a.append(c);a.append(b.getDom())};b.getDom=function(){return a};return b}(c)};lineapp=lineapp||{};lineapp.LoginView=lineapp.LoginView||function(c){return function(){var b=new lineapp.EventHub,a=$("<div></div>",{"class":"lineapp_loginview_wrapper"});$("<button></button>").html("Login").appendTo(a).on("click",function(){b.fireEvent("login")});b.getDom=function(){return a};return b}(c)};if("undefined"===typeof console)var console={log:function(){},warn:function(){}};
var localurl=window.location.protocol+"//"+window.location.host,client=new lineapp.Client;function init(){lineapp.LineAppService.init({client:client});lineapp.Facebook.init({appId:"471521269618702",channelUrl:localurl+"/static/channel.html"});var c=lineapp.LineAppPresenter();$(body).append(c.getView().getDom());c.open()}init();
