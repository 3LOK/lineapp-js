var http=http||{};
http.Factory=http.Factory||function(){return{create:function(b){var b=b||{},f=b.timeout||6E4,a=b.onload||function(){},d=b.onerror||function(){},c=b.onprogress||function(){},b=b.ontimeout||function(){};if("undefined"!==typeof XDomainRequest){var e=new XDomainRequest;e.timeout=f;e.onload=function(){e.fix=!0;a()};e.onerror=d;e.onprogress=c;e.ontimeout=b;e.setRequestHeader=function(){};e.setUserAgent=function(){};return e}if("undefined"!==typeof XMLHttpRequest){var g=new XMLHttpRequest;g.timeout=f;g.onload=
a;g.onerror=d;g.onprogress=c;g.ontimeout=b;g.setUserAgent=function(){};return g}if("undefined"!==typeof Ti){var h=Ti.Network.createHTTPClient({timeout:f,onload:a,onerror:d,onprogress:c,ontimeout:b});h.setUserAgent=function(a){h.setRequestHeader("User-Agent",a)};return h}throw Error("Could not find an HttpClient implementation.");}}}();http.create=http.create||http.Factory.create;var lineapp=lineapp||{};
lineapp.Client=lineapp.Client||function(b){return function(f){var f=f||{},a=f.apiUrl||"https://lineapp-prod.appspot.com/v1.0",f={},d=new lineapp.Protocol;f.request=function(c){c=c||{};d.post({url:a,obj:c.request||null,callback:c.callback||function(){}})};return f}(b)};lineapp=lineapp||{};
lineapp.EventHub=lineapp.EventHub||function(){return function(){var b={},f={};b.addEventListener=function(a,d){var c=f[a];"undefined"===typeof c&&(c=[],f[a]=c);c.push(d)};b.removeEventListener=function(a,d){var c=f[a];if("undefined"!==typeof c){var b=c.indexOf(d);-1!==b&&c.splice(b,1);0==c.length&&delete f[a]}};b.removeAllListeners=function(){f={}};b.addGeneralEventListener=function(a){b.addEventListener("__all__",a)};b.removeGeneralEventListener=function(a){b.removeEventListener("__all__",a)};b.fireEvent=
function(a,d){var c=f[a];if("undefined"!==typeof c)for(var b=0,g=c.length;b<g;++b)c[b](d);c=f.__all__;if("undefined"!==typeof c){b=0;for(g=c.length;b<g;++b)c[b](a,d)}};b.getNumListeners=function(){var a=0,b;for(b in f)a+=f[b].length;return a};return b}()};lineapp=lineapp||{};
lineapp.LineAppService=lineapp.LineAppService||function(){var b=new lineapp.EventHub,f=null;b.request=function(a){var a=a||{},b=a.request||{},c=a.promise||new utils.Promise;if(a.callback){var e=a.callback;c.done(function(){e.apply(this,arguments)})}f.request({request:b,callback:function(a){c.resolve(a)}})};b.init=function(a){a=a||{};f=a.client||null};return b}();lineapp=lineapp||{};
lineapp.LineManagement=lineapp.LineManagement||function(b){return function(){function b(c){j=c.timestamp;switch(c.type){case "join":i.NORMAL.push({id:c.clientId.id,ask:k,joinTimestamp:c.timestamp});break;case "leave":a(c);break;case "set_price":d(c);break;default:console.warn("Unkown event type",c)}}function a(a){i.NORMAL=_.reject(i.NORMAL,function(b){return b.id===a.clientId.id});i.VIP=_.reject(i.VIP,function(b){return b.id===a.clientId.id})}function d(a){_.each(i.NORMAL,function(b){b.id===a.clientId.id&&
(b.ask=a.price.amount)});_.each(i.VIP,function(b){b.id===a.clientId.id&&(b.ask=a.price.amount)})}function c(){l&&e({},function(){setTimeout(c,5E3)})}function e(a,b){m.push({request:a,callback:b});o||g()}function g(){if(0===m.length)o=!1;else{o=!0;var a=m.shift(),c={type:"update",lineId:n,after:j,accessToken:lineapp.Facebook.getAccessToken()},c=_.extend(c,a.request);lineapp.LineAppService.request({request:c,callback:function(c){try{if(c.error)alert(c.error.message);else{var d=c.value.events||[];_.each(d,
b);h.fireEvent("changed",{events:d})}}catch(e){}a.callback&&a.callback();g()}})}}var h=new lineapp.EventHub,k=500,i={},n=null,j=null;h.init=function(a){var c=a.events;n=a.lineId;"create"!==c.shift().type?alert("First event is not create!"):(i={NORMAL:[],VIP:[]},_.each(c,b))};h.performEvents=function(a){e({events:a})};h.getLines=function(){return i};var l=!1;h.startMonitoring=function(){l||(l=!0,c())};h.stopMonitoring=function(){l=!1};var m=[],o=!1;return h}(b)};lineapp=lineapp||{};
lineapp.getDefaultUserAgent=function(){return"lineapp4js (gzip)"};
lineapp.Protocol=lineapp.Protocol||function(b){return function(b){var b=b||{},a=b.userAgent||lineapp.getDefaultUserAgent();return{post:function(b){var c=b.url||null,f=b.obj||null,g=b.callback||function(){},h=http.create({onload:function(){g(JSON.parse(h.responseText))},onerror:function(){g({error:{code:"protocol",message:"protocol error"}})},timeout:b.timeout||6E4});h.open("POST",c);h.setUserAgent(a);h.setRequestHeader("Content-Type","application/json");h.setRequestHeader("Accept","application/json");
h.send(JSON.stringify(f))}}}(b)};var utils=utils||{};utils.Promise=utils.Promise||function(){function b(){if(f)for(;0<a.length;)a.pop().apply(this,d)}var f=!1,a=[],d;this.done=function(c){a.push(c);b();return this};this.resolve=function(){d=_.toArray(arguments);f=!0;b()};this.isResolved=function(){return f};this.getValue=function(){return d};return this};
utils.Promise.when=function(){function b(){f||_.all(_.invoke(a,"isResolved"))&&d.resolve.apply(this,_.map(a,function(a){return a.getValue()[0]}))}var f=!1,a=[],d=new utils.Promise;_.each(arguments,function(c){var d=(new utils.Promise).done(b);a.push(d);c=c(d);c instanceof utils.Promise&&c.done(function(a){d.resolve(a)})});return d};lineapp=lineapp||{};
lineapp.Facebook="undefined"!==typeof FB?lineapp.Facebook||function(){function b(){c=d=null;a.fireEvent("logout")}function f(b){a.login(b.userID,b.accessToken)}var a=new lineapp.EventHub,d=null,c=null,e=!1,g=null;a.init=function(a){var a=a||{},c=a.channelUrl||null;g=a.appId||null;e=a.dontUseFB||!1;e||(FB.init({appId:g,channelUrl:c,status:!0,cookie:!0,xfbml:!0,oauth:!0}),FB.getLoginStatus(function(a){a.authResponse?f(a.authResponse):b()}))};a.getLoggedIn=function(){return null!==d};a.getAccessToken=
function(){return d};a.authorize=function(){e||FB.login(function(a){a.authResponse?f(a.authResponse):b()},void 0)};a.getUid=function(){return c};a.logout=function(){e?b():FB.logout()};a.getGraphPath=function(b,c,d){var f=http.create({onload:function(){d({success:!0,result:f.responseText})},onerror:function(a){d({error:!0,event:a})}}),b="https://graph.facebook.com/"+b,c=new lineapp.QueryStringBuilder(c);c.append("access_token",a.getAccessToken());b+=c.toString();f.autoEncodeUrl=!1;f.open("GET",b);
f.send()};a.login=function(b,f){d=f;c=b;a.fireEvent("login",{success:!0});lineapp.LineAppService.request({request:{type:"extend",accessToken:d,fbAppId:g},callback:function(a){a.error||(d=a.value.accessToken)}})};FB.Event.subscribe("auth.login",function(a){f(a.authResponse)});FB.Event.subscribe("auth.logout",function(){b()});return a}():lineapp.Facebook||function(){var b=new lineapp.EventHub;b.init=function(){};b.getLoggedIn=function(){return!1};b.getAccessToken=function(){return null};b.authorize=
function(){};b.getUid=function(){return null};b.logout=function(){};b.getGraphPath=function(b,a,d){d({error:!0})};return b}();lineapp=lineapp||{};lineapp.GetInLinePresenter=lineapp.GetInLinePresenter||function(b){return function(){var b=new lineapp.EventHub,a=new lineapp.GetInLineView;a.addEventListener("lineup",function(a){b.fireEvent("lineup",a)});b.getView=function(){return a};return b}(b)};lineapp=lineapp||{};
lineapp.InLinePresenter=lineapp.InLinePresenter||function(b){return function(b){var a=new lineapp.EventHub,b=b.lineManagement,d=new lineapp.InLineConfigPresenter({lineManagement:b}),c=new lineapp.InLineLinePresenter({lineManagement:b}),e=new lineapp.InLineView;e.addConfigView(d.getView());e.addLineView(c.getView());d.addEventListener("leave",function(){a.fireEvent("leave")});a.close=function(){d.close();c.close()};a.getView=function(){return e};return a}(b)};lineapp=lineapp||{};
lineapp.InLineConfigPresenter=lineapp.InLineConfigPresenter||function(b){return function(b){var a=new lineapp.EventHub,d=b.lineManagement,c=new lineapp.InLineConfigView;a.update=function(){var a=d.getLines();_.each(a,function(a){_.each(a,function(a,b){a.id===lineapp.Facebook.getUid()&&(c.setPosition(b+1),c.setTimeInLine(a.joinTimestamp),c.setAsk(a.ask),c.setEta(1E3),c.setTotalEarned(0))})})};a.update();c.addEventListener("leave",function(){a.fireEvent("leave")});c.addEventListener("setprice",function(a){d.performEvents([{type:"set_price",
price:{destination:"yoavamit@yahoo.com",currency:"USD",amount:a.value},clientId:{ns:"com.facebook",id:lineapp.Facebook.getUid()}}])});a.close=function(){c.close()};a.getView=function(){return c};return a}(b)};
lineapp.InLineLinePresenter=lineapp.InLineLinePresenter||function(b){return function(b){var a=new lineapp.EventHub,d=b.lineManagement,c=new lineapp.InLineLineView;c.initLines(d.getLines());var e=function(a){_.each(a.events,function(a){console.log("Handling",a.type);switch(a.type){case "join":c.onJoinEvent({person:{id:a.clientId.id,ask:500,joinTimestamp:a.timestamp}});break;case "leave":c.onLeaveEvent({person:{id:a.clientId.id}});break;case "set_price":c.onSetPriceEvent({person:{id:a.clientId.id},
amount:a.price.amount})}})};d.addEventListener("changed",e);a.getView=function(){return c};a.close=function(){d.removeEventListener("changed",e)};return a}(b)};lineapp=lineapp||{};
lineapp.LineAppPresenter=lineapp.LineAppPresenter||function(b){return function(){function b(){i?console.warn("onLogin >> called twice."):(i=!0,console.log("onLogin >> Start."),lineapp.LineAppService.request({request:{type:"update",lineId:k},callback:function(b){b.error&&alert(b.error.message);b=b.value.events||[];console.log("onEvents >> Start.",b);h.init({events:b,lineId:k});h.startMonitoring();b=a();console.log("onEvents >> inLine",b);b?c():d()}}))}function a(){var a=_.values(h.getLines());return _.chain(a).flatten().pluck("id").contains(lineapp.Facebook.getUid()).value()}
function d(){var b=new lineapp.GetInLinePresenter;g.showGetInLineView(b.getView());b.addEventListener("lineup",function(){g.showWaiting();h.performEvents([{type:"join",clientId:{ns:"com.facebook",id:lineapp.Facebook.getUid()}}])});var d=function(){console.log("onNotInLine >> Checking if inline");a()&&(h.removeEventListener("changed",d),c())};h.addEventListener("changed",d);g.hideWaiting()}function c(){console.log("onInLine >> Start");var b=new lineapp.InLinePresenter({lineManagement:h});g.showInLineView(b.getView());
b.addEventListener("leave",function(){g.showWaiting();h.performEvents([{type:"leave",clientId:{ns:"com.facebook",id:lineapp.Facebook.getUid()}}])});var c=function(){console.log("onNotInLine >> Checking if not inline");a()||(h.removeEventListener("changed",c),b.close(),d())};h.addEventListener("changed",c);g.hideWaiting()}var e=new lineapp.EventHub,g=new lineapp.LineAppView,h=new lineapp.LineManagement,k="5629499534213120";e.open=function(){console.log("open >> Start.");lineapp.Facebook.getLoggedIn()?
(console.log("open >> Already logged in."),b()):(console.log("open >> Logging in."),lineapp.Facebook.addEventListener("login",function(a){console.log("open >> Logged in.",a);b()}),lineapp.Facebook.authorize())};var i=!1;e.getView=function(){return g};return e}(b)};lineapp=lineapp||{};
lineapp.GetInLineView=lineapp.GetInLineView||function(b){return function(){var b=new lineapp.EventHub,a=$("<div></div>");$("<button></button>").html("Get In Line!").appendTo(a).on("click",function(){b.fireEvent("lineup")});b.getDom=function(){return a};return b}(b)};lineapp=lineapp||{};
lineapp.InLineConfigView=lineapp.InLineConfigView||function(b){return function(){function b(){if(c){var d=(new Date).getTime()-c,d=parseInt(d/1E3),f=parseInt(d/60/60),e=parseInt(d/60)-60*f,d=d-60*e-3600*f;h.html(a(f)+":"+a(e)+":"+a(d))}}function a(a){a=""+a;1===a.length&&(a="0"+a);return a}var d=new lineapp.EventHub,c=null,e=$("<div></div>"),g=$("<div></div>",{"class":"position"}).appendTo(e),h=$("<div></div>",{"class":"timeinline"}).appendTo(e),k=$("<div></div>",{"class":"timeeta"}).appendTo(e),
i=$("<select></select>").appendTo(e),n=$("<div></div>").appendTo(e);$("<button></button>").html("Leave").appendTo(e).on("click",function(){d.fireEvent("leave")});$("<option></option>",{value:100,html:"$1"}).appendTo(i);$("<option></option>",{value:200,html:"$2"}).appendTo(i);$("<option></option>",{value:300,html:"$3"}).appendTo(i);$("<option></option>",{value:400,html:"$4"}).appendTo(i);$("<option></option>",{value:500,html:"$5"}).appendTo(i);$("<option></option>",{value:1E3,html:"$10"}).appendTo(i);
$("<option></option>",{value:1500,html:"$15"}).appendTo(i);$("<option></option>",{value:2E3,html:"$20"}).appendTo(i);i.change(function(){d.fireEvent("setprice",{value:i.val()})});var j=setInterval(b,1E3);d.setPosition=function(a){g.html(a)};d.setTimeInLine=function(a){c=a;b()};d.setEta=function(a){k.html(a)};d.setAsk=function(a){i.val(a)};d.setTotalEarned=function(a){n.val(a)};d.getDom=function(){return e};d.close=function(){clearInterval(j);intervalId=null};return d}(b)};lineapp=lineapp||{};
lineapp.InLineLineView=lineapp.InLineLineView||function(b){return function(){function b(a){j+=55;k.css({width:j});var c=$("<div></div>",{"class":"spotsaver"}).appendTo(i);_.defer(function(){var b=$("<div></div>",{"class":"vip"}).css({left:c.position().left+5}).hide().appendTo(i).fadeIn({complete:d});g[a.id]={dom:b,spot:c}})}function a(a){j+=55;k.css({width:j});var b=$("<div></div>",{"class":"spotsaver"}).appendTo(n);_.defer(function(){var c=$("<div></div>",{"class":"normal"}).html(a.ask).css({left:b.position().left+
5}).hide().appendTo(n).fadeIn({complete:d});g[a.id]={dom:c,spot:b}})}function d(){if(0===l.length)m=!1;else{m=!0;var b=l.shift();console.log("Animating",b.type);switch(b.type){case "join":b=b.params.person;console.log(b);a(b);break;case "leave":c(b.params)}}}function c(a){var b=a.person;g[b.id].dom.fadeOut({complete:function(){g[b.id].dom=null;g[b.id].spot||(delete g[b.id],j-=55,k.css({width:j}),d())}});g[b.id].spot.fadeOut({complete:function(){g[b.id].spot=null;g[b.id].next||(delete g[b.id],d())}})}
var e=new lineapp.EventHub,g={},h=$("<div></div>",{"class":"lineapp_inlinelineview_wrapper"}),k=$("<div></div>",{"class":"waitingline"}).appendTo(h);$("<div></div>",{"class":"desk"}).appendTo(k);var i=$("<div></div>",{"class":"vipline"}).appendTo(k),n=$("<div></div>",{"class":"normalline"}).appendTo(k),j=55;e.initLines=function(c){i.empty();n.empty();g={};_.each(c.VIP,function(a){b(a)});_.each(c.NORMAL,function(b){a(b)})};e.onJoinEvent=function(a){l.push({type:"join",params:a});m||d()};e.onLeaveEvent=
function(a){l.push({type:"leave",params:a});m||d()};e.onSetPriceEvent=function(a){g[a.person.id].dom.html(a.amount)};var l=[],m=!1;e.swap=function(a){var b=g[a.id1].dom,a=g[a.id2].dom;b.animate({left:a.css("left"),duration:1E3});a.animate({left:b.css("left"),duration:1E3})};XXXX=e.swap;e.getDom=function(){return h};return e}(b)};lineapp=lineapp||{};
lineapp.InLineView=lineapp.InLineView||function(b){return function(){var b=new lineapp.EventHub,a=$("<div></div>",{"class":"lineapp_inlineview_wrapper"}),d=$("<div></div>",{"class":"config"}).appendTo(a),c=$("<div></div>",{"class":"line"}).appendTo(a);b.addConfigView=function(a){d.append(a.getDom())};b.addLineView=function(a){c.append(a.getDom())};b.getDom=function(){return a};return b}(b)};lineapp=lineapp||{};
lineapp.LineAppView=lineapp.LineAppView||function(b){return function(){var b=new lineapp.EventHub,a=$("<div></div>",{"class":"lineapp_lineappview_wrapper"}),d=$("<div></div>",{"class":"waiting"}).appendTo(a);$("<i class='icon-spin icon-spinner'></i>").appendTo(d);d.hide();b.showWaiting=function(){d.show()};b.hideWaiting=function(){d.hide()};b.showLogin=function(b){a.empty();a.append(d);a.append(b.getDom())};b.showGetInLineView=function(b){a.empty();a.append(d);a.append(b.getDom())};b.showInLineView=
function(b){a.empty();a.append(d);a.append(b.getDom())};b.getDom=function(){return a};return b}(b)};if("undefined"===typeof console)var console={log:function(){},warn:function(){}};var localurl=window.location.protocol+"//"+window.location.host,client=new lineapp.Client;
function init(){lineapp.LineAppService.init({client:client});lineapp.Facebook.init({appId:"471521269618702",channelUrl:localurl+"/static/channel.html"});var b=lineapp.LineAppPresenter();$(body).append(b.getView().getDom());b.open()}init();
